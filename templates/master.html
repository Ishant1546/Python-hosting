<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Dashboard - Python Script Host</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1><i class="fas fa-server"></i> Python Script Host</h1>
                <p class="subtitle">Master Control Panel</p>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <i class="fas fa-user"></i>
                    <span>{{ username }}</span>
                    <a href="/logout" class="btn-logout">Logout</a>
                </div>
                <div class="quick-stats">
                    <span class="stat-badge"><i class="fas fa-microchip"></i> CPU: {{ cpu|round(1) }}%</span>
                    <span class="stat-badge"><i class="fas fa-memory"></i> RAM: {{ memory|round(1) }}%</span>
                    <span class="stat-badge"><i class="fas fa-hdd"></i> Disk: {{ disk|round(1) }}%</span>
                </div>
            </div>
        </header>

        <!-- Upload Panel -->
        <div class="upload-panel">
            <h2><i class="fas fa-upload"></i> Upload New Script</h2>
            <a href="/upload" class="btn-upload">
                <i class="fas fa-plus"></i> Upload Script
            </a>
            <span class="script-count">{{ total_scripts }} scripts hosted</span>
        </div>

        <!-- Scripts Grid -->
        <div class="scripts-container">
            <h2><i class="fas fa-code"></i> Managed Scripts</h2>
            
            {% if scripts|length == 0 %}
            <div class="no-scripts">
                <i class="fas fa-code-branch fa-3x"></i>
                <h3>No Scripts Uploaded Yet</h3>
                <p>Upload your first Python script to get started!</p>
                <a href="/upload" class="btn-primary">Upload First Script</a>
            </div>
            {% else %}
            <div class="scripts-grid" id="scripts-grid">
                {% for script in scripts %}
                <div class="script-card" id="script-{{ script.id }}">
                    <div class="script-header">
                        <div class="script-title">
                            <h3>{{ script.name }}</h3>
                            <span class="script-id">ID: {{ script.id }}</span>
                        </div>
                        <div class="script-status">
                            <span class="status-badge status-{{ script.status }}">
                                <i class="fas fa-circle"></i> {{ script.status|replace('_', ' ')|title }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="script-body">
                        <p class="script-description">{{ script.description or 'No description' }}</p>
                        
                        <div class="script-meta">
                            <div class="meta-item">
                                <i class="fas fa-user"></i>
                                <span>{{ script.author or 'Unknown' }}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-network-wired"></i>
                                <span>Port: {{ script.port }}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-folder"></i>
                                <span>{{ script.category or 'Uncategorized' }}</span>
                            </div>
                        </div>
                        
                        <div class="script-resources">
                            <div class="resource">
                                <small>Dashboard CPU:</small>
                                <div class="progress-bar small">
                                    <div class="progress-fill" id="dash-cpu-{{ script.id }}" 
                                         style="width: {{ script.dashboard_cpu or 0 }}%;"></div>
                                </div>
                            </div>
                            <div class="resource">
                                <small>Dashboard Memory:</small>
                                <span>{{ (script.dashboard_memory_mb or 0)|round(1) }} MB</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="script-footer">
                        <div class="script-controls">
                            <button class="btn-control btn-start" onclick="startScript('{{ script.id }}')" 
                                    id="btn-start-{{ script.id }}" {% if script.status == 'running' %}disabled{% endif %}>
                                <i class="fas fa-play"></i> Start
                            </button>
                            <button class="btn-control btn-stop" onclick="stopScript('{{ script.id }}')" 
                                    id="btn-stop-{{ script.id }}" {% if script.status != 'running' %}disabled{% endif %}>
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            <button class="btn-control btn-restart" onclick="restartScript('{{ script.id }}')">
                                <i class="fas fa-redo"></i> Restart
                            </button>
                            <a href="http://localhost:{{ script.port }}" target="_blank" class="btn-control btn-dashboard">
                                <i class="fas fa-external-link-alt"></i> Dashboard
                            </a>
                            {% if username == 'admin' %}
                            <button class="btn-control btn-delete" onclick="deleteScript('{{ script.id }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                        
                        <div class="script-actions">
                            <button class="btn-action" onclick="showLogs('{{ script.id }}')">
                                <i class="fas fa-scroll"></i> Logs
                            </button>
                            <button class="btn-action" onclick="showConfig('{{ script.id }}')">
                                <i class="fas fa-cog"></i> Config
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- System Monitor -->
        <div class="monitor-panel">
            <h2><i class="fas fa-chart-line"></i> System Monitor</h2>
            <div class="monitor-grid">
                <div class="monitor-card">
                    <h3>CPU Usage</h3>
                    <div class="gauge-container">
                        <div class="gauge" id="cpu-gauge">
                            <div class="gauge-fill" id="cpu-fill"></div>
                            <div class="gauge-text" id="cpu-text">0%</div>
                        </div>
                    </div>
                </div>
                <div class="monitor-card">
                    <h3>Memory Usage</h3>
                    <div class="gauge-container">
                        <div class="gauge" id="memory-gauge">
                            <div class="gauge-fill" id="memory-fill"></div>
                            <div class="gauge-text" id="memory-text">0%</div>
                        </div>
                    </div>
                </div>
                <div class="monitor-card">
                    <h3>Active Dashboards</h3>
                    <div class="dashboard-count">
                        <span class="count" id="active-dashboards">0</span>
                        <span class="label">/ {{ total_scripts }} running</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Panel -->
        <div class="logs-panel">
            <h2><i class="fas fa-terminal"></i> Master Logs</h2>
            <div class="logs-controls">
                <button class="btn-small" onclick="clearMasterLogs()">Clear</button>
                <button class="btn-small" onclick="refreshLogs()">Refresh</button>
            </div>
            <div class="logs-container">
                <pre id="master-logs"></pre>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div class="modal" id="logs-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Script Logs</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="modal-logs"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn-small" onclick="downloadLogs()">Download</button>
                <button class="btn-small" onclick="clearModalLogs()">Clear</button>
            </div>
        </div>
    </div>

    <script>
        let socket = io();
        let currentScriptId = null;
        
        // Initialize Socket.IO
        socket.on('connect', function() {
            console.log('Connected to master dashboard');
            socket.emit('request_update');
            setInterval(() => socket.emit('request_update'), 3000);
        });
        
        socket.on('scripts_update', function(data) {
            updateScripts(data.scripts);
            updateDashboardCount(data.scripts);
        });
        
        // Update scripts display
        function updateScripts(scripts) {
            scripts.forEach(script => {
                const card = document.getElementById(`script-${script.id}`);
                if (!card) return;
                
                // Update status
                const statusBadge = card.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = `status-badge status-${script.status}`;
                    statusBadge.innerHTML = `<i class="fas fa-circle"></i> ${script.status.replace('_', ' ').toUpperCase()}`;
                }
                
                // Update buttons
                const startBtn = document.getElementById(`btn-start-${script.id}`);
                const stopBtn = document.getElementById(`btn-stop-${script.id}`);
                
                if (startBtn && stopBtn) {
                    const isRunning = script.status === 'running';
                    startBtn.disabled = isRunning;
                    stopBtn.disabled = !isRunning;
                }
                
                // Update resources
                const dashCpu = document.getElementById(`dash-cpu-${script.id}`);
                if (dashCpu && script.dashboard_cpu) {
                    dashCpu.style.width = `${Math.min(script.dashboard_cpu, 100)}%`;
                }
            });
        }
        
        // Update dashboard count
        function updateDashboardCount(scripts) {
            const active = scripts.filter(s => s.status !== 'stopped').length;
            document.getElementById('active-dashboards').textContent = active;
        }
        
        // Script control functions
        async function startScript(scriptId) {
            try {
                const response = await fetch(`/api/start/${scriptId}`, { method: 'POST' });
                const result = await response.json();
                addMasterLog(`Starting script ${scriptId}: ${result.message}`);
            } catch (error) {
                addMasterLog(`Error starting script: ${error}`);
            }
        }
        
        async function stopScript(scriptId) {
            try {
                const response = await fetch(`/api/stop/${scriptId}`, { method: 'POST' });
                const result = await response.json();
                addMasterLog(`Stopping script ${scriptId}: ${result.message}`);
            } catch (error) {
                addMasterLog(`Error stopping script: ${error}`);
            }
        }
        
        async function restartScript(scriptId) {
            try {
                const response = await fetch(`/api/restart/${scriptId}`, { method: 'POST' });
                const result = await response.json();
                addMasterLog(`Restarting script ${scriptId}: ${result.message}`);
            } catch (error) {
                addMasterLog(`Error restarting script: ${error}`);
            }
        }
        
        async function deleteScript(scriptId) {
            if (!confirm('Are you sure you want to delete this script? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/delete/${scriptId}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById(`script-${scriptId}`).remove();
                    addMasterLog(`Deleted script ${scriptId}`);
                } else {
                    addMasterLog(`Error deleting script: ${result.message}`);
                }
            } catch (error) {
                addMasterLog(`Error deleting script: ${error}`);
            }
        }
        
        // Logs functions
        async function showLogs(scriptId) {
            currentScriptId = scriptId;
            try {
                const response = await fetch(`/api/script_logs/${scriptId}`);
                const result = await response.json();
                
                const modalLogs = document.getElementById('modal-logs');
                modalLogs.textContent = result.logs.join('');
                
                document.getElementById('logs-modal').style.display = 'block';
            } catch (error) {
                addMasterLog(`Error fetching logs: ${error}`);
            }
        }
        
        function showConfig(scriptId) {
            window.open(`http://localhost:${scriptId}/api/config`, '_blank');
        }
        
        function closeModal() {
            document.getElementById('logs-modal').style.display = 'none';
        }
        
        async function downloadLogs() {
            if (!currentScriptId) return;
            window.open(`/api/script_logs/${currentScriptId}/download`, '_blank');
        }
        
        function clearModalLogs() {
            document.getElementById('modal-logs').textContent = '';
        }
        
        function clearMasterLogs() {
            document.getElementById('master-logs').textContent = '';
        }
        
        function refreshLogs() {
            // Implement log refresh logic
        }
        
        // Add log to master logs
        function addMasterLog(message) {
            const logs = document.getElementById('master-logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        // System monitoring
        async function updateSystemStats() {
            try {
                const response = await fetch('/api/system_stats');
                const data = await response.json();
                
                // Update CPU gauge
                const cpuPercent = Math.round(data.cpu);
                document.getElementById('cpu-text').textContent = `${cpuPercent}%`;
                document.getElementById('cpu-fill').style.height = `${cpuPercent}%`;
                document.getElementById('cpu-fill').style.background = 
                    cpuPercent > 80 ? '#ef4444' : cpuPercent > 60 ? '#f59e0b' : '#10b981';
                
                // Update Memory gauge
                const memPercent = Math.round(data.memory.percent);
                document.getElementById('memory-text').textContent = `${memPercent}%`;
                document.getElementById('memory-fill').style.height = `${memPercent}%`;
                document.getElementById('memory-fill').style.background = 
                    memPercent > 80 ? '#ef4444' : memPercent > 60 ? '#f59e0b' : '#10b981';
                    
            } catch (error) {
                console.error('Error fetching system stats:', error);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initial system stats
            updateSystemStats();
            setInterval(updateSystemStats, 5000);
            
            // Close modal on outside click
            window.onclick = function(event) {
                const modal = document.getElementById('logs-modal');
                if (event.target === modal) {
                    closeModal();
                }
            };
        });
    </script>
</body>
</html>